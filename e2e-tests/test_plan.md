# 🃏 德州扑克游戏 E2E 功能测试计划

## 概述

本文档定义了德州扑克游戏的端到端功能测试用例，覆盖核心用户流程。基于项目的技术架构和产品设计，制定了完整的测试场景，确保系统的功能完整性和用户体验质量。

---

## 测试环境与架构

### 技术栈
- **前端**: React 19 + TypeScript + Vite + Tailwind CSS
- **后端**: Node.js + Express + TypeScript
- **数据库**: PostgreSQL + Redis
- **实时通信**: Socket.IO (WebSocket)
- **测试框架**: Playwright

### 测试环境要求
- 后端服务: `http://localhost:3001`
- 前端服务: `http://localhost:5173`
- 数据库: PostgreSQL + Redis (通过Docker Compose)
- 浏览器支持: Chromium

---

## 📋 测试分类与优先级

### 🥇 核心功能测试 (Critical - P0)
- 用户认证流程
- 房间管理基础功能
- 游戏基础流程

### 🥈 完整游戏体验测试 (High - P1)
- 多人游戏协作流程
- 实时通信和状态同步
- 复杂游戏场景

### 🥉 高级功能和边界测试 (Medium - P2)
- 错误处理和恢复
- 网络异常处理
- 性能和并发测试

---

## 🧪 详细测试用例

### 1. 用户认证流程测试 (P0)

#### 1.1 用户注册流程
**测试目标**: 验证新用户注册流程的完整性
**前置条件**: 访问登录页面
**测试步骤**:
1. 访问登录页面 (`/login`)
2. 切换到注册模式
3. 填写有效的用户名和密码
4. 提交注册表单
5. 验证注册成功跳转到大厅页面
6. 验证用户信息正确显示

**预期结果**:
- 成功创建新用户账户
- 自动登录并跳转到大厅页面
- 用户名在大厅页面正确显示
- JWT token保存到本地存储

**数据验证**:
- 数据库中用户记录正确创建
- 密码正确加密存储
- 初始筹码设置为默认值

---

#### 1.2 用户登录流程
**测试目标**: 验证已注册用户登录流程
**前置条件**: 已存在测试用户账户
**测试步骤**:
1. 访问登录页面
2. 输入正确的用户名和密码
3. 提交登录表单
4. 验证登录成功跳转到大厅
5. 验证用户状态持久化

**预期结果**:
- 成功验证用户身份
- 跳转到大厅页面
- 用户状态在页面刷新后保持

---

#### 1.3 认证表单验证
**测试目标**: 验证表单输入验证逻辑
**测试场景**:
- 空用户名提交
- 空密码提交
- 无效用户名格式
- 密码长度不足
- 重复用户名注册
- 错误用户名/密码登录

**预期结果**:
- 适当的错误消息显示
- 表单提交被阻止
- 用户体验友好的错误提示

---

#### 1.4 登录/注册模式切换
**测试目标**: 验证登录和注册模式间的切换
**测试步骤**:
1. 验证默认登录模式显示
2. 切换到注册模式，验证界面变化
3. 验证头像字段的显示/隐藏
4. 切换回登录模式
5. 验证表单数据在切换时清空

**预期结果**:
- 模式切换流畅无误
- 表单字段正确显示/隐藏
- 数据清空防止信息泄露

---

#### 1.5 退出登录功能
**测试目标**: 验证用户登出流程
**测试步骤**:
1. 登录到大厅页面
2. 点击退出登录按钮
3. 验证跳转回登录页面
4. 验证用户状态清除

**预期结果**:
- 成功清除用户会话
- 跳转到登录页面
- 本地存储的token被清除

---

### 2. 房间管理功能测试 (P0)

#### 2.1 房间创建流程
**测试目标**: 验证创建新游戏房间的完整流程
**前置条件**: 用户已登录到大厅页面
**测试步骤**:
1. 在大厅页面点击"创建房间"按钮
2. 在创建房间弹窗中设置房间参数:
   - 房间人数 (2-9人)
   - 大盲注金额
   - 小盲注金额
   - 房间密码 (可选)
3. 提交创建房间表单
4. 验证房间创建成功
5. 验证自动跳转到游戏页面
6. 验证创建者成为房主

**预期结果**:
- 房间在数据库中正确创建
- 房间状态设置为"等待玩家"
- 创建者自动加入房间
- 跳转到游戏页面 (`/game/:roomId`)

**数据验证**:
- Redis中房间状态正确初始化
- PostgreSQL中房间记录正确保存
- 房间参数设置正确

---

#### 2.2 房间列表显示和刷新
**测试目标**: 验证房间列表的实时更新
**测试步骤**:
1. 在大厅页面查看房间列表
2. 创建新房间，验证列表更新
3. 验证房间信息显示:
   - 房间ID
   - 玩家数量 (当前/最大)
   - 盲注信息
   - 房间状态
   - 是否有密码
4. 刷新页面验证数据持久化

**预期结果**:
- 房间列表实时更新
- 房间信息完整准确显示
- 数据持久化正确

---

#### 2.3 加入房间流程
**测试目标**: 验证玩家加入现有房间的流程
**测试场景**:

**2.3.1 加入无密码房间**
**测试步骤**:
1. 第二个用户登录到大厅
2. 在房间列表中选择无密码房间
3. 点击"加入房间"按钮
4. 验证成功加入房间
5. 验证跳转到游戏页面

**2.3.2 加入有密码房间**
**测试步骤**:
1. 选择有密码的房间
2. 点击"加入房间"
3. 输入正确的房间密码
4. 验证成功加入
5. 测试错误密码场景

**预期结果**:
- 正确密码能成功加入房间
- 错误密码显示适当错误消息
- 房间玩家列表实时更新

---

#### 2.4 快速开始功能
**测试目标**: 验证快速匹配游戏功能
**测试步骤**:
1. 在大厅页面点击"快速开始"
2. 系统自动匹配或创建房间
3. 验证成功加入合适的房间
4. 验证房间参数符合快速开始规则

**预期结果**:
- 快速匹配到合适房间
- 如无可用房间则创建新房间
- 匹配逻辑合理高效

---

#### 2.5 房间状态管理
**测试目标**: 验证房间状态的正确管理
**测试场景**:
- 等待玩家状态
- 游戏进行中状态
- 游戏结束状态
- 房间解散场景

**验证要点**:
- 状态转换逻辑正确
- 状态在前后端保持同步
- 异常情况下状态恢复

---

### 3. 游戏基础流程测试 (P0)

#### 3.1 游戏开始流程
**测试目标**: 验证游戏启动的完整流程
**前置条件**: 房间内有足够玩家 (至少2人)
**测试步骤**:
1. 房间创建者点击"开始游戏"
2. 验证游戏状态初始化:
   - 玩家位置分配
   - 庄家位置设定
   - 小盲/大盲位置确定
3. 验证初始发牌:
   - 每个玩家获得2张手牌
   - 手牌对其他玩家隐藏
4. 验证盲注收取
5. 验证进入翻牌前(Pre-flop)阶段

**预期结果**:
- 游戏状态正确初始化
- 所有玩家收到正确的手牌
- 盲注正确收取到底池
- 行动顺序正确设定

**数据验证**:
- Redis中游戏状态正确设置
- 所有玩家状态同步
- 牌堆正确洗牌和分发

---

#### 3.2 玩家操作流程
**测试目标**: 验证玩家在游戏中的基本操作
**测试操作**:

**3.2.1 弃牌 (Fold)**
**测试步骤**:
1. 轮到玩家行动时点击"弃牌"
2. 验证玩家状态变为"已弃牌"
3. 验证手牌隐藏
4. 验证行动轮转到下一玩家

**3.2.2 过牌 (Check)**
**测试步骤**:
1. 在无需跟注时点击"过牌"
2. 验证行动轮转
3. 验证筹码不变

**3.2.3 跟注 (Call)**
**测试步骤**:
1. 有人下注后点击"跟注"
2. 验证筹码正确扣除
3. 验证底池金额增加
4. 验证行动轮转

**3.2.4 加注 (Raise)**
**测试步骤**:
1. 输入加注金额或使用滑条
2. 点击"加注"确认
3. 验证筹码扣除正确
4. 验证底池更新
5. 验证其他玩家需要跟注

**3.2.5 全下 (All-in)**
**测试步骤**:
1. 点击"全下"按钮
2. 验证所有筹码投入底池
3. 验证边池计算 (如适用)
4. 验证玩家状态变为"全下"

**预期结果**:
- 所有操作正确执行
- 筹码计算准确
- 游戏状态实时更新
- 其他玩家看到操作反馈

---

#### 3.3 游戏阶段推进
**测试目标**: 验证游戏各阶段的正确推进
**测试阶段**:

**3.3.1 翻牌前 (Pre-flop)**
- 验证每个玩家行动机会
- 验证盲注机制
- 验证下注轮完成条件

**3.3.2 翻牌 (Flop)**
- 验证发出3张公共牌
- 验证新的下注轮开始
- 验证行动顺序重置

**3.3.3 转牌 (Turn)**
- 验证发出第4张公共牌
- 验证下注轮逻辑

**3.3.4 河牌 (River)**
- 验证发出第5张公共牌
- 验证最后下注轮

**3.3.5 摊牌 (Showdown)**
- 验证手牌公开
- 验证牌型比较
- 验证胜者确定

**预期结果**:
- 阶段转换时机正确
- 公共牌正确发放
- 所有玩家状态同步

---

#### 3.4 结算和奖池分配
**测试目标**: 验证游戏结束时的结算逻辑
**测试场景**:

**3.4.1 单一胜者场景**
**测试步骤**:
1. 游戏进行到摊牌阶段
2. 验证牌型比较正确
3. 验证胜者确定
4. 验证奖池分配给胜者
5. 验证筹码更新

**3.4.2 平局场景**
**测试步骤**:
1. 多个玩家有相同牌型
2. 验证奖池平分
3. 验证余数处理

**3.4.3 边池场景**
**测试步骤**:
1. 有玩家全下时创建边池
2. 验证主池和边池正确计算
3. 验证多个边池的分配逻辑

**预期结果**:
- 奖池分配算法正确
- 筹码变动准确记录
- 玩家余额正确更新

---

#### 3.5 游戏历史和统计
**测试目标**: 验证游戏数据的记录和显示
**验证内容**:
- 操作历史正确记录
- 筹码变动历史
- 手牌历史 (结束后)
- 玩家统计更新

---

### 4. 多人游戏协作流程测试 (P1)

#### 4.1 多用户同时游戏
**测试目标**: 验证多个真实用户同时游戏的体验
**测试设置**: 使用3-4个浏览器会话模拟不同用户
**测试流程**:
1. 多个用户同时注册和登录
2. 创建房间并加入
3. 开始完整游戏流程
4. 验证所有用户界面同步
5. 测试并发操作处理

**关键验证点**:
- 实时状态同步
- 操作冲突处理
- 网络延迟容错
- 用户界面一致性

---

#### 4.2 复杂游戏场景
**测试目标**: 验证复杂游戏情况的处理
**测试场景**:

**4.2.1 多人全下场景**
- 多个玩家全下
- 复杂边池计算
- 多个胜者分配

**4.2.2 超时处理场景**
- 玩家操作超时
- 自动弃牌机制
- 游戏继续进行

**4.2.3 玩家中途离开**
- 玩家断线处理
- 座位保留机制
- 游戏状态维护

---

#### 4.3 房间管理协作
**测试目标**: 验证房间内多人协作功能
**测试内容**:
- 房主权限管理
- 踢出玩家功能 (如实现)
- 房间设置修改
- 游戏重新开始

---

### 5. 实时通信和状态同步测试 (P1)

#### 5.1 WebSocket连接管理
**测试目标**: 验证WebSocket连接的稳定性
**测试场景**:
- 初始连接建立
- 连接断开重连
- 多标签页连接处理
- 服务器重启恢复

**验证要点**:
- 连接状态指示正确
- 重连机制可靠
- 数据不丢失

---

#### 5.2 实时状态同步
**测试目标**: 验证游戏状态在所有客户端的同步
**测试内容**:
- 玩家操作实时广播
- 游戏状态变更同步
- 房间状态更新
- 错误状态同步

**性能要求**:
- 状态同步延迟 < 100ms
- 数据一致性 100%
- 无状态冲突

---

#### 5.3 网络异常处理
**测试目标**: 验证网络异常情况的处理
**测试场景**:
- 网络暂时断开
- 网络延迟较高
- 服务器压力过大
- 客户端浏览器崩溃

**预期行为**:
- 优雅的错误处理
- 用户友好的提示
- 数据状态保护
- 自动恢复机制

---

### 6. 错误处理和恢复测试 (P2)

#### 6.1 客户端错误处理
**测试场景**:
- JavaScript运行时错误
- 网络请求失败
- 本地存储异常
- 浏览器兼容性问题

**验证要点**:
- 错误不影响其他功能
- 适当的错误提示
- 错误日志记录
- 用户操作引导

---

#### 6.2 服务端错误处理
**测试场景**:
- 数据库连接失败
- Redis缓存异常
- 内存不足
- 并发冲突

**验证要点**:
- 服务稳定性
- 数据一致性保护
- 错误恢复机制
- 监控和告警

---

#### 6.3 数据一致性测试
**测试目标**: 验证在异常情况下数据的一致性
**测试场景**:
- 游戏进行中服务器重启
- 数据库连接中断
- 缓存数据丢失
- 网络分区问题

**验证要点**:
- 数据不丢失
- 状态可恢复
- 用户体验连续性

---

### 7. 用户界面和体验测试 (P2)

#### 7.1 响应式设计测试
**测试目标**: 验证在不同设备上的用户体验
**测试设备**:
- 桌面端 (1920x1080, 1366x768)
- 平板端 (768x1024)
- 手机端 (375x667, 414x896)

**验证内容**:
- 布局适配正确
- 交互元素可用
- 文字清晰可读
- 操作便捷性

---

#### 7.2 动画和视觉效果
**测试目标**: 验证游戏动画和视觉反馈
**测试内容**:
- 发牌动画流畅
- 筹码移动效果
- 胜者高亮动画
- 操作反馈效果

**性能要求**:
- 动画帧率 > 30fps
- 动画不卡顿
- 不影响游戏性能

---

#### 7.3 无障碍访问测试
**测试目标**: 验证应用的无障碍性
**验证内容**:
- 键盘导航支持
- 屏幕阅读器兼容
- 颜色对比度
- 焦点管理

---

### 8. 性能和并发测试 (P2)

#### 8.1 单房间性能测试
**测试目标**: 验证单个房间的性能表现
**测试参数**:
- 最大玩家数: 9人
- 游戏轮数: 连续50轮
- 监控指标: CPU、内存、网络

**性能指标**:
- 响应时间 < 200ms
- 内存使用稳定
- CPU使用率 < 70%

---

#### 8.2 多房间并发测试
**测试目标**: 验证系统支持多房间并发
**测试规模**:
- 同时房间数: 10个
- 总用户数: 50人
- 测试时长: 30分钟

**验证要点**:
- 系统稳定性
- 性能无明显下降
- 用户体验无影响

---

#### 8.3 压力测试
**测试目标**: 确定系统性能极限
**测试方法**:
- 逐步增加并发用户
- 监控系统响应时间
- 确定性能拐点

**目标指标**:
- 支持100+并发用户
- 错误率 < 1%
- 响应时间 < 500ms

---

## 📊 测试覆盖率和成功标准

### 功能覆盖率目标
- **用户认证流程**: 100%覆盖
- **房间管理功能**: 95%覆盖
- **游戏核心流程**: 100%覆盖
- **多人协作功能**: 90%覆盖
- **实时通信**: 95%覆盖
- **错误处理**: 80%覆盖

### 成功标准
- **P0用例通过率**: 100%
- **P1用例通过率**: ≥95%
- **P2用例通过率**: ≥85%
- **性能测试**: 满足所有性能指标
- **兼容性测试**: 主流浏览器100%兼容

---

## 🛠️ 测试实施策略

### 测试环境搭建
1. **独立测试环境**: 独立的数据库和Redis实例
2. **数据隔离**: 每次测试使用独立的测试数据
3. **自动化部署**: 使用Docker确保环境一致性

### 测试数据管理
1. **用户数据**: 自动生成唯一的测试用户
2. **房间数据**: 动态创建和清理测试房间
3. **游戏数据**: 模拟各种游戏场景的数据

### 测试执行策略
1. **冒烟测试**: 每次代码提交后执行P0用例
2. **回归测试**: 每日执行完整测试套件
3. **性能测试**: 每周执行一次
4. **兼容性测试**: 发布前执行

### 测试报告和监控
1. **测试报告**: 自动生成详细的测试报告
2. **失败分析**: 自动截图和日志收集
3. **趋势监控**: 测试通过率和性能趋势分析
4. **告警机制**: 关键测试失败时立即通知

---

## 📝 测试用例实施计划

### 第一阶段 (1-2周): 核心功能测试
- 完善用户认证流程测试
- 实现房间管理功能测试
- 开发游戏基础流程测试

### 第二阶段 (1-2周): 多人协作测试
- 开发多用户同时游戏测试
- 实现复杂游戏场景测试
- 完善实时通信测试

### 第三阶段 (1周): 错误处理和性能测试
- 实现错误处理测试
- 开发性能和并发测试
- 完善用户体验测试

### 第四阶段 (1周): 完善和优化
- 测试用例优化
- 测试稳定性提升
- 测试报告完善

---

## 🔧 技术实现细节

### 测试工具配置
```typescript
// playwright.config.ts 关键配置
export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  workers: process.env.CI ? 1 : undefined,
  reporter: [['html'], ['json', { outputFile: 'test-results.json' }]],
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
    { name: 'webkit', use: { ...devices['Desktop Safari'] } },
  ],
});
```

### 页面对象模式实现
```typescript
// 游戏页面对象
export class GamePage {
  constructor(private page: Page) {}
  
  async joinRoom(roomId: string, password?: string) { /* ... */ }
  async startGame() { /* ... */ }
  async makeAction(action: 'fold' | 'check' | 'call' | 'raise', amount?: number) { /* ... */ }
  async waitForGameState(state: GameState) { /* ... */ }
}
```

### 测试数据生成
```typescript
// 测试数据工厂
export class TestDataFactory {
  static generateUser() { /* ... */ }
  static generateRoom() { /* ... */ }
  static generateGameState() { /* ... */ }
}
```

---

## 📈 持续改进计划

### 测试质量提升
1. **代码覆盖率监控**: 确保测试覆盖所有关键代码路径
2. **测试稳定性**: 减少flaky测试，提高测试可靠性
3. **测试性能**: 优化测试执行时间，提高反馈速度

### 测试自动化增强
1. **CI/CD集成**: 与开发流程深度集成
2. **自动化报告**: 丰富的测试结果展示
3. **智能重试**: 对网络相关的测试失败进行智能重试

### 测试覆盖扩展
1. **API测试**: 增加后端API的直接测试
2. **安全测试**: 增加安全相关的测试用例
3. **负载测试**: 扩展性能测试的覆盖范围

---

*文档版本: 1.0*  
*创建日期: 2025-06-15*  
*覆盖功能: 德州扑克游戏完整功能*  
*测试框架: Playwright E2E Testing*